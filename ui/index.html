<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Demo</title>
  <style>
    body{font-family:system-ui,Arial;max-width:760px;margin:40px auto;padding:0 16px}
    textarea,input,button{font-size:16px}
    textarea{width:100%}
    #out{background:#f6f6f6;padding:12px;border-radius:8px}
    #out h2:has(+ *), #out h2 + * {margin-top: 8px}
    #out a {display: inline-block; word-break: break-all}
    /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–ø–∏—Å–∫—É –¥–∂–µ—Ä–µ–ª */
    #out ul {list-style-type: disc; padding-left: 24px; margin: 12px 0}
    #out ul li {margin: 6px 0; line-height: 1.6}
    #out ol {padding-left: 24px; margin: 12px 0}
    #out ol li {margin: 6px 0; line-height: 1.6}
    /* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ –ø–µ—Ä–µ–Ω–æ—Å–∏ –¥–ª—è –¥–æ–≤–≥–∏—Ö URL */
    #out a {word-break: break-all; display: inline-block}
  </style>
</head>
<body>
  <h1>AI Demo</h1>
  <p>Enter your question:</p>
  <textarea id="q" rows="5" placeholder="Napriklad: Pomo≈æ so ≈æiakom 3. roƒçn√≠ka..."></textarea><br />
  <button id="btn">Ask</button>
  <h3>Answer</h3>
  <div id="out">(already empty)</div>

  <!-- –î–æ–¥–∞—î–º–æ –ª–µ–≥–∫–∏–π markdown-—Ä–µ–Ω–¥–µ—Ä–µ—Ä -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.getElementById('btn').onclick = async () => {
      const q = document.getElementById('q').value.trim();
      const out = document.getElementById('out');
      if(!q){ out.textContent = 'Enter your question ‚Üë'; return; }
      out.textContent = 'Thinking...';
      try {
        const r = await fetch('/api/ask', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({question:q})
        });
        const data = await r.json();
        let md = data.answer ?? '';
        
        // –û–±—Ä–æ–±–∫–∞ –¥–∂–µ—Ä–µ–ª - –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π Markdown —Å–ø–∏—Å–æ–∫
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Å–µ–∫—Ü—ñ—é "Zdroje" —ñ –≤—Å—ñ –¥–∂–µ—Ä–µ–ª–∞ –ø—ñ—Å–ª—è –Ω–µ—ó
        const zdrojeMatch = md.match(/## üìö Zdroje\n\n(.*?)(?=\n\n|$)/s);
        if (zdrojeMatch) {
          const zdrojeText = zdrojeMatch[1];
          // –†–æ–∑–±–∏–≤–∞—î–º–æ –Ω–∞ –æ–∫—Ä–µ–º—ñ –¥–∂–µ—Ä–µ–ª–∞ (–ø–æ —Ä—è–¥–∫–∞—Ö)
          const sources = zdrojeText.split('\n').filter(line => line.trim());
          // –§–æ—Ä–º—É—î–º–æ Markdown —Å–ø–∏—Å–æ–∫
          const formattedSources = sources.map(line => {
            // –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤—ñ –ø—Ä–æ–±—ñ–ª–∏ —ñ —Ñ–æ—Ä–º–∞—Ç—É—î–º–æ
            line = line.trim();
            // –Ø–∫—â–æ —Ä—è–¥–æ–∫ –≤–∂–µ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ "-", –∑–∞–ª–∏—à–∞—î–º–æ —è–∫ —î
            if (line.startsWith('-')) return line;
            // –Ø–∫—â–æ —Ä—è–¥–æ–∫ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ —á–∏—Å–ª–∞ —ñ –∫—Ä–∞–ø–∫–∏, –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –Ω–∞ —Å–ø–∏—Å–æ–∫
            const numMatch = line.match(/^(\d+)\.\s*(.+)$/);
            if (numMatch) {
              return `- ${numMatch[2]}`;
            }
            // –Ø–∫—â–æ —Ä—è–¥–æ–∫ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ "[—á–∏—Å–ª–æ]", –¥–æ–¥–∞—î–º–æ "-"
            const bracketMatch = line.match(/^\[(\d+)\]\s*(.+)$/);
            if (bracketMatch) {
              return `- [${bracketMatch[1]}] ${bracketMatch[2]}`;
            }
            return `- ${line}`;
          }).join('\n');
          
          // –ó–∞–º—ñ–Ω—é—î–º–æ —Å—Ç–∞—Ä—É —Å–µ–∫—Ü—ñ—é –Ω–∞ –Ω–æ–≤—É
          md = md.replace(/## üìö Zdroje\n\n.*/s, `## üìö Zdroje\n\n${formattedSources}\n`);
        }
        
        out.innerHTML = marked.parse(md);
      } catch (e) {
        out.textContent = 'Failed: ' + e;
      }
    };
  </script>
</body>
</html>
